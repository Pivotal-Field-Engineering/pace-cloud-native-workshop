= PACE Cloud Native Developer Workshop

The purpose of this workshop is to introduce some basic features of Spring Boot, and deploy the resulting application to Pivotal Cloud Foundry.

== Creating a Basic Spring Boot application

. Navigate to http://start.spring.io/, and provide a general overview of the site.  Be sure to mention the following:
- Point out the site can generate Maven or Gradle projects
- It's possible to create shell projects for Java and other languages, and
- Click on the _Show Version_ link to display the full set of available options, directing attention to the numerous dependencies available.

. If it's not running already launch SpringSource Tool Suite (STS)

. `File` -> `New` -> `Spring Starter Project`.  Point out the *Service URL* is set to http://start.spring.io/.

. Use the following information to fill out the input fields (Other values take them as default). Click *Next* when done.

+
[options="header"]
[width="20%"]
|=======================
|Field|Value
|Name| *sb-basic-demo*
|Group| *io.pivotal.pace*
|Artifact| *sb-basic-demo*
|Package| *io.pivotal.pace*
|=======================

+
image:img/starter1.png[Spring Boot Initializer]

. Select * `2.0.0.M7` (or most current 2.0 release).

. Add the following dependencies: `Actuator`, `JPA`, `H2`, `MySQL`, `Web`, `Rest Repositories`. Click *Finish* when done.

+
image:img/starter2.png[Spring Boot Initializer]

. Open the `pom.xml` file, and draw attention to the included dependencies, relating them back to the ones selected in the Initializer.

. Create an `SBController` class, and paste the following code into it:

+
.SBController.java
[source,java]
----
package io.pivotal.pace;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class SBController {

	@Value("${greetingLanguage}")
	private String language;

	@RequestMapping("/")
	public String greetingLanguage() {
		return "Greeting language is " + language;
	}
}
----

. Open the `SbBasicDemoApplicationTests` class in the `src/test/java` folder, and paste the following code into it:

+
.SbBasicDemoApplicationTests.java
[source,java]
----
package io.pivotal.pace;

import static org.assertj.core.api.Assertions.assertThat;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.SpringBootTest.WebEnvironment;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.test.context.junit4.SpringRunner;

@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment=WebEnvironment.RANDOM_PORT)
public class SbBasicDemoApplicationTests {

	@Autowired
	private TestRestTemplate restTemplate;

	@Test
	public void testHomePage() {
		String body = this.restTemplate.getForObject("/", String.class);
		assertThat(body).contains("Greeting");
	}

}
----

. In the `src/main/resources` directory, rename the `application.properties` file to `application.yml`, and paste in the following content:

+
.application.yml
[source,yaml]
----
logging:
  level:
    io.pivotal: info

greetingLanguage: English
----

. Run the application from the IDE, navigate to http://localhost:8080

+
image:img/greeting-lang.png[]

. From the IDE, right-click on the `SbBasicDemoApplicationTests` class and run it as a J-Unit test.  The test should pass.

. Demonstrate building and running from the command line.  Emphasize the fact that an executable JAR is created, that can be run as a Java app from the command line.

+
[source,bash]
----
mvn clean package
.
.
.
java -jar target/sb-basic-demo-0.0.1-SNAPSHOT.jar
----

== Properties and Profiles

. Demonstrate how you can override property values in a Spring Boot application using environment variable settings.

+
From the command line, override the `greetingLanguage` property by setting the `GREETINGLANGUAGE` environment variable to `Spanish`.

+
[source,bash]
----
GREETINGLANGUAGE=Spanish java -jar target/sb-basic-demo-0.0.1-SNAPSHOT.jar
----

+
Emphasize the fact that this will be important when we later deploy our application to PCF.

. Back in the IDE, add profile settings to the `application.yml` file.  The resulting file should have the following content.

+
.application.yml
[source,yaml]
----
logging:
  level:
    io.pivotal: info

greetingLanguage: English
---
spring:
  profiles: dev
greetingLanguage: French
---
spring:
  profiles: prod
greetingLanguage: Spanish
----

. Rebuild and launch the application again from the command line, this time changing the active profile and observing the result in the browser.

[source,bash]
----
java -jar target/sb-basic-demo-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev
----

+
image:img/dev-profile.png[]

== Add a Database Repository

. Create a new `Greeting` domain object class, `Greeting.java` with the following content:

+
.Greeting.java.
[source,java]
----
package io.pivotal.pace;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;

@Entity
public class Greeting {

  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private Integer id;
  private String language;
  private String text;

  public Greeting(String language, String text) {
    super();
    this.language = language;
    this.text = text;
  }

  @Override
  public String toString() {
    return "Greeting [id=" + id + ", language=" + language + ", text=" + text + "]";
  }

  public Integer getId() {
    return id;
  }

  public String getLanguage() {
    return language;
  }

  public String getText() {
	    return text;
	  }

  public Greeting() {}
}
----

. Create a `GreetingRepository` class, which will be backed by a database.  Paste the following code into the `GreetingRepository.java` class.

+
.GreetingRepository.java.
[source,java]
----
package io.pivotal.pace;

import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;
import org.springframework.data.repository.query.Param;

public interface GreetingRepository extends JpaRepository<Greeting, Integer> {
	  List<Greeting> findByLanguage(@Param("language") String language);
}
----

. Let's add a `greeting` endpoint to our `SBController` class to return the greeting from the repository, based on the language.  The resulting class should look as follows:

+
.SBController.java.
[source,java]
----
package io.pivotal.pace;

import java.util.List;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class SBController {

	private GreetingRepository greetingRepository;

	@Value("${greetingLanguage}")
	private String language;

	public SBController(GreetingRepository greetingRepository) {
		this.greetingRepository = greetingRepository;
	}

	@RequestMapping("/")
	public String greetingLanguage() {
		return "Greeting language is " + language;
	}

	@RequestMapping("/greeting")
	public String greeting() {
		List<Greeting> greeting = greetingRepository.findByLanguage(language);
		if (greeting.isEmpty())
			return "Welcome";
		else
			return greeting.get(0).getText();
	}
}
----

. Add a property into the `application.yml` file to tell Spring to generate the DB tables on startup.  The resulting file should have the following content:

+
.application.yml.
[source,yaml]
----
logging:
  level:
    io.pivotal: info

spring:
  jpa:
    hibernate:
      ddl-auto: auto

greetingLanguage: English
---
spring:
  profiles: dev
greetingLanguage: French
---
spring:
  profiles: prod
greetingLanguage: Spanish
----

. Finally, we will need to initialize our repository. Create a `GreetingConfig` class that will insert the greetings on startup.

+
.GreetingConfig.java.
[source,java]
----
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class GreetingConfig {

  Logger logger = LoggerFactory.getLogger(GreetingConfig.class);

  // Loads the database on startup
  @Bean
  CommandLineRunner loadDatabase(GreetingRepository gr) {
    return commandLineRunner -> {
      logger.info("loading database..");
      gr.save(new Greeting("English","Hello"));
      gr.save(new Greeting("Spanish","Hola"));
      gr.save(new Greeting("French","Bonjour"));
      logger.debug("record count: {}", gr.count());
      gr.findAll().forEach(x -> logger.debug(x.toString()));
    };
  }
}
----

. Package and launch the app locally from the command line using different environment variable settings, and verify that the correct greeting is showing when hitting the `http://localhost:8080/greeting` endpoint.  Examine the log output, noting that the H2 in-memory database is being used.

+
[source,bash]
----
GREETINGLANGUAGE=Spanish java -jar target/sb-basic-demo-0.0.1-SNAPSHOT.jar
----

+
image:img/greeting-hola.png[]

== Running on PCF

. Push the app to PCF.

+
[source,bash]
----
cf push sb-basic-demo -p target/sb-basic-demo-0.0.1-SNAPSHOT.jar --random-route
----

+
Walk the audience through the output of the push process, describing what is happening at various points.  Open the Apps Manager and provide a tour of the interface.  Examine the logs, again pointing out that the in-memory database is being used.

. Extract the manifest for the app.

+
[source,bash]
----
cf create-app-manifest sb-basic-demo
----

+
Examine the contents of the manifest file.

+
.sb-basic-demo_manifest.yml.
[source,yaml]
----
applications:
- name: sb-basic-demo
  disk_quota: 1G
  instances: 1
  memory: 1G
  routes:
  - route: sb-basic-demo-nonrepresentational-incredulity.cfapps.io
  stack: cflinuxfs2
----

. Create a MySQL service instance, and bind the app to it.

+
[source,bash]
----
cf create-service cleardb spark demo-db
cf bind-service sb-basic-demo demo-db
----
